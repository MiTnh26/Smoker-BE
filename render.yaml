services:
  # =============================================
  # 1. MySQL 8.0 – Private service (internal only, persistent disk)
  # =============================================
  - type: pserv
    name: smoker-mysql
    runtime: image  # Pull prebuilt image
    image: mysql:8.0
    plan: starter  # Free tier OK cho test; upgrade cho disk lớn
    envVars:
      - key: MYSQL_ROOT_PASSWORD
        value: root123456  # Bắt buộc; đổi thành secret mạnh
      - key: MYSQL_DATABASE
        value: revive_adserver
      - key: MYSQL_USER
        value: smoker
      - key: MYSQL_PASSWORD
        value: smoker123
    disk:  # Persistent volume (như volumes trong compose)
      name: mysql-data
      mountPath: /var/lib/mysql
      sizeGB: 1  # 1GB; free limit 0.1GB → cần paid nếu >0.1
    region: singapore  # Gần VN; đổi oregon nếu US
    numInstances: 1  # Single instance cho DB

  # =============================================
  # 2. Revive Adserver (Apache + PHP) – Public web service
  # =============================================
  - type: web
    name: smoker-revive
    runtime: image  # Pull prebuilt
    image: jitesoft/revive-adserver:latest
    plan: starter
    startCommand: apache2-foreground  # Lệnh start từ image (như CMD trong Dockerfile)
    healthCheckPath: /revive  # Path để Render check healthy (tương tự healthcheck trong compose)
    envVars:
      - key: REVIVE_DB_HOST
        fromService:  # Internal connect đến MySQL
          type: pserv
          name: smoker-mysql
          property: hostname  # Render inject (e.g., mysql-abc123.internal)
      - key: REVIVE_DB_PORT
        value: "3306"
      - key: REVIVE_DB_USER
        value: smoker
      - key: REVIVE_DB_PASSWORD
        value: smoker123
      - key: REVIVE_DB_NAME
        value: revive_adserver
      - key: REVIVE_URL
        value: https://${RENDER_EXTERNAL_HOSTNAME}/revive  # Render tự inject domain
    disks:  # Persistent cho config/cache/images (như volumes)
      - name: revive-var
        mountPath: /var/www/html/var  # Config + cache
        sizeGB: 1
      - name: revive-www
        mountPath: /var/www/html  # Thư mục chính (sẽ tự cài lần đầu)
        sizeGB: 1
      - name: revive-plugins
        mountPath: /var/www/html/plugins
        sizeGB: 1
      - name: revive-images
        mountPath: /var/www/html/www/images
        sizeGB: 1
    region: singapore
    autoDeploy: true  # Auto deploy khi push Git

  # =============================================
  # 3. Node.js Backend – Public web service (build từ Dockerfile)
  # =============================================
  - type: web
    name: smoker-node
    runtime: docker  # Build từ Dockerfile
    dockerfilePath: ./Dockerfile  # Giả sử ở root; đổi ./node/Dockerfile nếu folder con
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: DB_HOST
        fromService:  # Internal connect đến MySQL
          type: pserv
          name: smoker-mysql
          property: hostname
      - key: DB_PORT
        value: "3306"
      - key: DB_USER
        value: smoker
      - key: DB_PASSWORD
        value: smoker123
      - key: DB_NAME
        value: revive_adserver
      - key: REVIVE_URL
        value: https://smoker-revive.onrender.com/revive  # Hoặc dùng ${RENDER_EXTERNAL_HOSTNAME} nếu dynamic
    port: 9999  # Expose port từ Dockerfile (thêm EXPOSE 9999 nếu chưa có)
    healthCheckPath: /health  # Endpoint check trong server.js (tùy chỉnh nếu có)
    region: singapore
    autoDeploy: true