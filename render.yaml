previews:
  generation: automatic

services:
  # 1) MySQL 8.0 – Private service
  - type: pserv                     # private service must use "pserv"
    name: smoker-mysql
    runtime: image                  # pull prebuilt image
    image: mysql:8.0
    plan: starter
    numInstances: 1
    envVars:
      - key: MYSQL_ROOT_PASSWORD
        value: root123456
      - key: MYSQL_DATABASE
        value: revive_adserver
      - key: MYSQL_USER
        value: smoker
      - key: MYSQL_PASSWORD
        value: smoker123
    disk:                           # note: singular "disk"
      name: mysql-data
      mountPath: /var/lib/mysql
      sizeGB: 1
    region: singapore

  # 2) Revive Adserver (Apache + PHP) – Public web service
  - type: web
    name: smoker-revive
    runtime: image
    image: jitesoft/revive-adserver:latest
    plan: starter
    dockerCommand: apache2-foreground   # use dockerCommand for image/runtime docker
    healthCheckPath: /revive
    envVars:
      - key: REVIVE_DB_HOST
        fromService:
          name: smoker-mysql
          type: pserv
          property: host                # use "host" (private network hostname)
      - key: REVIVE_DB_PORT
        value: "3306"
      - key: REVIVE_DB_USER
        value: smoker
      - key: REVIVE_DB_PASSWORD
        value: smoker123
      - key: REVIVE_DB_NAME
        value: revive_adserver
      # If you want the public URL for this revive service in OTHER services,
      # reference RENDER_EXTERNAL_URL from that other service (see Node service below).
    disk:
      name: revive-data
      mountPath: /var/www/html        # attach a single persistent disk; put files under subpaths
      sizeGB: 5
    region: singapore
    autoDeploy: true

  # 3) Node.js Backend – build from Dockerfile
  - type: web
    name: smoker-node
    runtime: docker
    dockerfilePath: ./Dockerfile     # build from repo Dockerfile
    plan: starter
    envVars:
      - key: NODE_ENV
        value: production
      - key: DB_HOST
        fromService:
          name: smoker-mysql
          type: pserv
          property: host
      - key: DB_PORT
        value: "3306"
      - key: DB_USER
        value: smoker
      - key: DB_PASSWORD
        value: smoker123
      - key: DB_NAME
        value: revive_adserver
      - key: REVIVE_URL
        fromService:
          name: smoker-revive
          type: web
          envVarKey: RENDER_EXTERNAL_URL   # get the revive public URL for backend use
    healthCheckPath: /health
    region: singapore
    autoDeploy: true
